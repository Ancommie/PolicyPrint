# PolicyPrint

本项目基于 https://sousuo.www.gov.cn/ 全文检索含指定主题关键字的条目，并将其打印成PDF格式。

## 项目简介

本项目提供了一套基于 **Selenium** 和 **Edge** 浏览器 DevTools 协议的自动化爬取脚本，用于从“中国政府网站内搜索页”中按关键词和时间范围批量下载政府公文的 PDF 文件。

**最新版本特性：**
- **多关键词支持**：支持配置多个检索主题词，脚本将依次自动检索。
- **无头模式运行**：默认后台静默运行（Headless Mode），无需打开浏览器窗口，提升运行效率。
- **智能内存保护**：内置浏览器自动重启机制，防止因长时间运行导致的内存溢出或驱动崩溃。
- **稳健性增强**：增加了页面加载超时强制停止、死链跳过及自动重试机制。

**核心功能：**
- 自动翻页检索指定年份区间中内容包含主题关键词的公文列表
- 筛选标题中包含特定公文类型关键词（如“通知”、“意见”）的条目
- 利用浏览器 DevTools 接口生成并保存高清 PDF
- 按年度自动创建文件夹分类存储

> ⚠️ **声明**：该工具仅供政策文本分析研究使用，请勿用于商业用途或恶意攻击政府网站。

## 环境依赖

1.  **Python 版本**
    - 建议使用 Python 3.8 及以上

2.  **第三方库**
    - `selenium`
    - (其他如 `os`, `time`, `base64`, `re` 均为 Python 标准库，无需额外安装)

3.  **浏览器驱动**
    - **Microsoft Edge** 浏览器（建议更新至最新版）
    - 对应版本的 **msedgedriver**（需加入系统环境变量或放在脚本同级目录）

## 参数说明

请在脚本顶部的 `========== 参数设置 ==========` 区域进行修改：

| 参数名称 | 类型 | 默认值示例 | 说明 |
| :--- | :--- | :--- | :--- |
| `SEARCH_KEYWORDS_LIST` | `List[str]` | `["生态", "绿色", "低碳", ...]` | **(新)** 待检索的主题关键词列表，脚本会遍历列表逐个搜索 |
| `INCLUDE_KEYWORDS` | `List[str]` | `['决议', '决定', '命令', ...]` | 文章标题必须包含的文种或特征词，用于二次筛选有效公文 |
| `BASE_PATH` | `str` | `r"E:\政策文件"` | 下载文件保存根目录，脚本会在此目录下按年份创建子文件夹 |
| `YEARS` | `range` | `range(2013, 2026)` | 爬取年份范围（起始年包含，结束年不包含） |
| `Sleep_time` | `int/float` | `1` | 翻页及请求时的基础等待间隔（秒），防止IP被封 |
| `RESTART_THRESHOLD` | `int` | `30` | **(新)** 浏览器重启阈值。每处理指定数量的文件后重启浏览器以释放内存 |
| `code` / `sign` | `str` | 需手动填入 | ⚠️ **必填**。从官网搜索接口获取的校验参数，用于通过反爬验证 |

## 使用步骤

1.  **获取校验参数 (`code` & `sign`)**
    - 打开浏览器访问 [https://sousuo.www.gov.cn](https://sousuo.www.gov.cn)
    - 打开开发者工具 (F12) -> Network (网络) 面板
    - 输入任意关键词搜索
    - 在网络请求中找到 `search.shtml`，查看其 **Payload** 或 **URL参数**
    - 复制其中的 `code` 和 `sign` 值

2.  **配置脚本**
    - 打开 Python 脚本，将获取到的 `code` 和 `sign` 填入对应的变量中。
    - 根据需求修改 `SEARCH_KEYWORDS_LIST`、`YEARS` 和 `BASE_PATH`。

3.  **运行脚本**
    ```bash
    python your_script_name.py
    ```
    *注：由于开启了 Headless 模式，运行时不会看到浏览器窗口弹出，请关注控制台输出日志。*

4.  **结果检验**
    - 进入 `BASE_PATH` 指定目录
    - 查看按年份命名的文件夹及内部生成的 PDF 文件

## 注意事项

1.  **Headless 模式**：
    当前代码默认启用 `--headless=new`。如果需要观察浏览器运行过程（用于调试），请注释掉函数 `get_new_driver` 中的 `option.add_argument('--headless=new')` 行。

2.  **反爬与稳定性**：
    - 脚本包含 `try...except` 重试逻辑，遇到 `invalid session id` 会自动重启驱动。
    - 若出现大量“列表页加载超时”或“无法打印”，请检查网络状况或尝试更新 `code`/`sign`（这两个参数有有效期）。

3.  **文件名规范**：
    脚本会自动替换文件名中的非法字符（如 `\ / : * ? " < > |`），并截取前50个字符作为文件名，避免路径过长错误。

4.  **内存管理**：
    针对长期运行可能导致的内存泄漏问题，脚本通过 `RESTART_THRESHOLD` 参数控制浏览器重启频率。如果你的机器内存较小，建议调低该数值（如设为 10）。

## 联系方式

如有问题或功能改进建议，欢迎联系开发者：

- **邮箱**：zouchuze@gmail.com
